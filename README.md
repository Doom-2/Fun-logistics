# Сервис загрузки данных из Google Sheets в таблицу СУБД PostgreSQL
###### Тестовое задание

## Стек
* Python
* PostgreSQL
* Django REST framework

## Функциональность
* Загрузка данных из документа Google Sheets в таблицу СУБД PostgreSQL.
* Синхронизация данных по заданному интервалу.
* Отображение данных в админ-панели Django.
* Дополнение исходных данных новыми.

## Запуск сервиса на локальном компьютере
1. Удостоверьтесь, что выполнены следующие требования: \
   1.1 Платформы Docker, Docker Compose и СУБД PostgreSQL установлены на вашем компьютере. \
   1.2 На сервере Postgres есть учетная запись (роль), к которой у вас есть доступ. \
   1.3 Создана база данных, где владелец - ваш пользователь. \
   1.4 Порт 8000 доступен для подключения. \
   1.5 Замените зашифрованный файл `/orders/management/commands/google_api_credentials.json` на свой собственный или запросите исходный файл у владельца репозитория.
2. Склонируйте этот репозиторий на локальный компьютер.
3. Переименуйте файл `.env.example` в `.env` и замените все значения, обрамленные угловыми скобками на свои, символы `<>` нужно удалить. \
   3.1 В переменных `DATABASE_URL` и `CONNECTION_STR` замените `<your_host>` на `localhost` при запуске API не из Docker контейнера или на `db`, если запуск планируется из Docker контейнера. \
   3.2 В переменных `DB_USER`, `DB_PASSWORD`, `DB_NAME`, а также в соответствущих местах переменных `DATABASE_URL` и `CONNECTION_STR` вставьте свои учетные данные (см. пп. 1.3). \
   3.2 `SPREADSHEET_NAME` - имя таблицы с которой будет выполняться синхронизация, \
       вставьте значение `orders` - название тестовой таблицы. \
   3.3 `UPDATE_INTERVAL` интервал синхронизации Google таблицы с БД в секундах. \
   Пример заполнения файла `.env` для запуска API из Docker контейнера:
   ```
   DEBUG=on
   SECRET_KEY=kfj$^%$bnkj@^&%nbverw3453j34kdfd;onvsda04rit34rternf
   DATABASE_URL=psql://test_user:test_pwd@db:5432/test_db
   CONNECTION_STR=postgresql+psycopg2://test_user:test_pwd@db:5432/test_db
   DB_USER=test_user
   DB_PASSWORD=test_pwd
   DB_NAME=test_db
   DJANGO_SUPERUSER_NAME=admin
   DJANGO_SUPERUSER_PASSWORD=admin_pwd
   SPREADSHEET_NAME=orders
   UPDATE_INTERVAL=30
   ```
4. Запуск API из Docker-контейнера (рекомендуется): \
   4.1 Перейдите в корень проекта. \
   4.2 Выполните в терминале команду `docker compose up -d` (или `docker-compose up -d`). \
       Все нужные образы загрузятся с Docker Hub. \
   4.3 В БД автоматически создается 1-й пользователь с правами администратора. Учетные данные при этом берутся из переменных окружения `DJANGO_SUPERUSER_NAME` и `DJANGO_SUPERUSER_PASSWORD`, используйте их для последующей авторизации. \
   4.4 Приложение будет доступно по адресу [http://127.0.0.1:8000/](http://127.0.0.1:8000/). \
   4.5 Загрузите панель администратора по адресу [http://127.0.0.1:8000/admin/](http://127.0.0.1:8000/admin/), авторизуйтесь и перейдите по ссылке `Заказы`, чтобы отобразить синхронизованную таблицу заказов. \
   4.6 Синхронизация данных Google таблицы с БД будет выполняться автоматически, \
       используя сервис `Ofelia` из docker-образа (аналог `Cron`). \
       Интервал синхронизации задается переменной окружения `UPDATE_INTERVAL`.
5. Запуск API через командную строку (без Docker): \
   5.1 Перейдите в корень проекта. \
   5.2 Примените миграции в базе данных командой `python3 manage.py migrate`. \
   5.3 Создайте пользователя с правами администратора, выполнив команду пользователя \
       `python3 manage.py add_admin`. Учетные данные при этом берутся из переменных окружения `DJANGO_SUPERUSER_NAME` и `DJANGO_SUPERUSER_PASSWORD`. \
        Или используйте стандартную команду `python3 manage.py createsuperuser`. \
   5.4 Загрузите данные из Google таблицы в базу командой `python3 manage.py get_orders orders`, \
       где аргументом передается имя Google таблицы (`orders`). \
   5.5 Выполните команду `python3 manage.py runserver` для взаимодействия с API. \
   5.6 Запустите циклическую синхронизацию данных Google таблицы с БД, \
       выполнив команду `python3 orders/load_order_service.py`. \
       Интервал синхронизации задается переменной окружения `UPDATE_INTERVAL`. \
   5.6 Следуйте пп. 4.4-4.5.


   <p align="center">
    <img src="/images/Orders_table.png" alt="Orders table"/>
    </p>

## Доступные маршруты

### Модель Order:

* `order/` - CRUD-операции на базе шаблонов Django REST framework. Доступен только режим чтения (HTTP-метод GET).

### Модель User:

* `user/signup/` - создание пользователя
* `user/login/` - аутентификация пользователя
* `user/profile/` - карточка пользователя
* `user/logout/` - выход из системы

###### Примечание: CRUD для пользователя сделан для удобства его создания через форму DRF.
