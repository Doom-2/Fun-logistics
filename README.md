# Сервис «Занимательная логистика»


## Стек
* Python
* Django
* PostgreSQL
* Celery + Redis
* Google Charts
* HTML + CSS
* JavaScript


## О проекте
Сервис используется для синхронизации документа Google Sheets с таблицей СУБД PostgreSQL.
Исходный документ представляет собой таблицу учета заказов, изображенную ниже:

<div>
  <p align="center">
    <img src="/images/orders_gspread.png" alt="Orders gspread"/>
  </p>
</div>

В БД добавляется новая колонка, `стоимость в руб.`, которая вычисляется с учетом актуального курса доллара.
Полученная таблица базы данных и график на ее основе отображаются на html-странице.


## Функциональность
* Отображение загруженных данных на web-странице и в админ-панели Django.
* Синхронизация изменений исходного документа с БД и в HTML по обновлению страницы.
* Обновление курса доллара  по заданному интервалу через API ЦБ РФ с пересчетом значений колонки `стоимость в руб.` \
  Интервал обновления, установленный в проекте - ежедневно в 9 утра, может быть изменен соответствующей настройкой (см. пп. 6.7).
* Обработка некорректного ввода данных в исходную таблицу.


## Запуск сервиса на локальном компьютере
1. Удостоверьтесь, что выполнены следующие требования: \
   1.1 Платформы Docker, Docker Compose и СУБД PostgreSQL установлены на вашем компьютере. \
   1.2 На сервере Postgres есть учетная запись (роль), к которой у вас есть доступ. \
   1.3 Создана база данных, где владелец - ваш пользователь. \
   1.4 Порт 8000 доступен для подключения. \
   1.5 У вас сервисный аккаунт на платформе Google Cloud и `.json` файл с учетными данными (см. `google_api_credentials.example.json`). \
       Файл может быть предоставлен владельцем данного репозитория по запросу.
2. Склонируйте данный репозиторий на локальный компьютер.
3. Переименуйте файл `.env.example` в `.env` и замените все значения, обрамленные угловыми скобками на свои, символы `<>` нужно удалить. \
   3.1 В переменных `DATABASE_URL` и `CONNECTION_STR` замените `<your_host>` на `localhost` при запуске API не из Docker контейнера или на `db`, если запуск планируется из Docker контейнера. \
   3.2 В переменных `DB_USER`, `DB_PASSWORD`, `DB_NAME`, а также в соответствущих местах переменных `DATABASE_URL` и `CONNECTION_STR` вставьте свои учетные данные (см. пп. 1.2-1.3). \
   3.3 `SPREADSHEET_NAME` - имя таблицы с которой будет выполняться синхронизация, \
       вставьте значение `orders` - название тестовой таблицы. \
   3.4 `REDIS_HOST` установите в `redis` для запуска приложения из Docker контейнера и в `0.0.0.0` если планируете запускать на локальном компьютере. \
   3.5 `REDIS_PORT` - TCP-порт, используемый хранилищем Redis, рекомендуется использовать значение по умолчанию `6379`.

   Пример заполнения файла `.env` для запуска приложения из Docker контейнера:
   ```
   DEBUG=on
   SECRET_KEY=kfj$^%$bnkj@^&%nbverw3453j34kdfd;onvsda04rit34rternf
   DATABASE_URL=psql://test_user:test_pwd@db:5432/test_db
   CONNECTION_STR=postgresql+psycopg2://test_user:test_pwd@db:5432/test_db
   DB_USER=test_user
   DB_PASSWORD=test_pwd
   DB_NAME=test_db
   DJANGO_SUPERUSER_NAME=admin
   DJANGO_SUPERUSER_PASSWORD=admin_pwd
   SPREADSHEET_NAME=orders
   UPDATE_INTERVAL=30
   REDIS_HOST=redis
   REDIS_PORT=6379
   ```
4. Переименуйте файл `orders/google_api_credentials.example.json` в `orders/google_api_credentials.json` и заполните его своими учетными данными (см. пп. 1.5).
5. Запуск API из Docker-контейнера (рекомендуется): \
   5.1 Перейдите в корень проекта. \
   5.2 Выполните в терминале команду `docker compose up -d --build` \
       (или `docker-compose up -d --build`) для сборки и загрузки образов с хранилища Docker Hub. \
   5.3 В БД автоматически создается 1-й пользователь с правами администратора. Учетные данные при этом берутся из переменных окружения `DJANGO_SUPERUSER_NAME` и `DJANGO_SUPERUSER_PASSWORD`, используйте их для последующей авторизации. \
   5.4 Для асинхронного выполнения задач будут запущены соответствующие контейнеры: \
       - брокер сообщений Redis для хранения очередей задач, \
       - обработчик задач `celery worker` для задачи по загрузке данных из Google таблицы, \
       - планировщик задач `celery beat` для интервального обновления курса доллара с пересчетом значений колонки `стоимость в руб.`. \
   5.5 Приложение будет доступно по адресу [http://127.0.0.1:8000/](http://127.0.0.1:8000/). \
       Смотрите раздел [Инструкция по использованию](#Инструкция-по-использованию).
6. Запуск API через командную строку (без Docker): \
   6.1 Перейдите в корень проекта. \
   6.2 Примените миграции в базе данных командой `python3 manage.py migrate`. \
   6.3 Создайте пользователя с правами администратора, выполнив команду пользователя \
       `python3 manage.py add_admin`. Учетные данные при этом берутся из переменных окружения `DJANGO_SUPERUSER_NAME` и `DJANGO_SUPERUSER_PASSWORD`. \
        Или используйте стандартную команду `python3 manage.py createsuperuser`. \
   6.4 Выполните первичную загрузку данных из Google таблицы в БД командой пользователя \
       `python3 manage.py get_orders orders`, где аргументом передается имя Google таблицы (`orders`). \
   6.5 Выполните команду `docker run -d -p 6379:6379 redis` для развертывания брокера сообщений Redis в Docker контейнере. \
       Платформа Docker при необходимости загрузит образ Redis с хранилища Docker Hub и запустит соответсвующий контейнер. \
   6.6 Запустите обработчик задач `celery worker` командой  \
       `celery -A google_sheets_to_db worker -l info` для асинхронного выполнения задачи по загрузке данных из Google таблицы. \
   6.7 Запустите (в другом окне терминала) планировщик задач `celery beat` командой  \
       `celery -A google_sheets_to_db beat -l info` для интервального выполнения асинхронной задачи обновления курса доллара с пересчетом значений колонки `стоимость в руб.` \
       Изменить интервал можно в файле `google_sheets_to_db/celery.py` следующей настройкой:

   ```
       app.conf.beat_schedule = {
           'update_price_rub_each_hour':
               {
         'task': 'orders.tasks.update_price_rub',
         'schedule': crontab(minute=0, hour=9),
               },
       }
   ```
   Установите новое значение аргументов функции `crontab`, следуя указаниям с [оф. сайта](https://docs.celeryq.dev/en/stable/userguide/periodic-tasks.html#crontab-schedules). \
   6.8 Выполните команду `python3 manage.py runserver` для взаимодействия с API. \
   6.9 Приложение будет доступно по адресу [http://127.0.0.1:8000/](http://127.0.0.1:8000/). \
       Смотрите раздел [Инструкция по использованию](#Инструкция-по-использованию).


## Инструкция по использованию
1. Отобразить таблицу заказов в админ-панели: \
   1.1 Загрузите панель администратора по адресу [http://127.0.0.1:8000/admin/](http://127.0.0.1:8000/admin/). \
   1.2 Авторизуйтесь c учетными данными суперпользователя (см. пп. 5.3, 6.3) или создайте нового по маршруту [user/signup](http://127.0.0.1:8000/user/signup). \
   1.3 Перейдите по ссылке `Заказы`.
       <div>
         <p align="center">
           <img src="/images/orders_django_admin.png" alt="Orders django-admin"/>
         </p>
       </div>
2. Отобразить детальную информацию по заказу в админ-панели: \
   2.1 Нажмите на любую ссылку в колонке `ЗАКАЗ №`. \
   2.2 Нажмите кнопку `Close`, чтобы закрыть карточку заказа.
3. Синхронизировать данные исходного документа Google Sheets с БД из админ-панели: \
   3.1 Выберите в раскрывающемся списке `Action` пункт `Load data from spreadsheet`. \
   3.2 Нажмите кнопку `Go`. \
   3.3 Обновите страницу через 5 сек.
4. Отобразить список заказов и статистику в виде графика на web странице: \
   4.1 Авторизуйтесь через админ-панель или создайте нового пользователя (см. пп. 1.2). \
   4.2 Загрузите страницу по адресу [http://127.0.0.1:8000/](http://127.0.0.1:8000/).
       <div>
         <p align="center">
           <img src="/images/orders_web.png" alt="Orders django-admin"/>
         </p>
       </div>
5. Синхронизировать данные исходного документа Google Sheets с БД и на web-странице:
   * обновите страницу 2 раза с интервалом 5 сек.

   ###### Примечание: 2 раза обновлять страницу нужно для исполнения задачи в очереди и для отображения загруженных данных соответственно.
6. График отображает общую стоимость заказов в $, сгруппированную по датам отгрузки. \
   Данный функционал создан с помощью интерактивного web-сервиса Google Charts.


## Доступные маршруты

* `/` - редирект на orders
* `orders/` - главный интерфейс
* `user/signup/` - создание пользователя
* `user/login/` - аутентификация пользователя
* `user/profile/` - карточка пользователя
* `user/logout/` - выход из системы.

###### Примечание: CRUD для пользователя сделан для удобства его создания через форму DRF.


## Обратная связь

###### Автор проекта: [phramov945@gmail.com](mailto:phramov945@gmail.com)
